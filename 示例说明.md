# 发票下载整理机器人

这个机器人程序可以将发票邮件中的发票pdf文件自动下载整理，但是发票邮件格式并不标准，有下载失败的可能。

程序用python编写，以源码提供，可以自行修改。总的来说配置比较简单，但还是需要一点点基础。

虽然用自己常用的邮箱也可以，但还是强烈建议为接收发票邮件单独申请一个邮箱。下面就从邮箱申请开始，对发票机器人的配置过程进行说明。

## 申请邮箱

任何支持IMAP协议的邮箱都可以，国内常用的免费邮箱都支持的，这里以网易163邮箱为例。

1. 打开[网易邮箱主页](https://mail.163.com/) https://mail.163.com/，点击注册新账号。
2. 按照注册向导完成邮箱注册。

## 创建收信规则

1. 注册成功后登录邮箱，点击左侧边栏“其他文件夹”位置的"+"号，新建一个“发票”文件夹。这一步是可选步骤，如果不创建的话，机器人程序中也会创建。为发票邮件单独创建文件夹，将邮件分类，方便管理。

   ![新建“发票”文件夹](https://imgs.boringhex.top/blog/20231012205738.png)

2. 点击新建的"发票"文件夹，页面会提示"设置来信分类"，如下图所示：

    ![设置"发票"来信分类](https://imgs.boringhex.top/blog/20231012210514.png)

3. 如果上一步没有找到"来信分类"页面，就点击上方的"设置"按钮，然后点击"常规设置"，进入设置页面，左侧找到"来信分类"选项，如下图所示：

    ![来信分类](https://imgs.boringhex.top/blog/20231012211030.png)

4. 新建来信分类规则：主题包含"发票"，则移动到"发票"文件夹。

    ![新建分类规则](https://imgs.boringhex.top/blog/20231012211230.png)

5. 保存设置，新建来信分类规则成功。
6. 使用其他邮箱可参考上述步骤，不同邮箱可能有些差异，但一般都是在邮箱设置中进行收信规则设置。

## 开启IMAP服务

1. 在设置标签页左侧，点击"POP3/SMTP/IMAP"选项，进入IMAP服务设置页面。

    ![IMAP服务设置](https://imgs.boringhex.top/blog/20231012212000.png)

2. 点击"IMAP/SMTP服务"右侧的“开启”，会弹出验证页面，进行验证后才能开启IMAP服务。
3. 验证通过后，会弹出IMAP服务授权码，这一步一定要注意，这个授权码只显示一次，一定要保存下来，后面要用到。可以为这个授权码设置一个助记名称，比如"fapiao_bot"。
4. 点击确定后，IMAP服务就开启了。"收取选项"这个可以设置最近30天，也可以设置全部，因为后面会设置机器人每天运行，所以不会漏掉邮件。
5. 其他邮箱的设置大同小异，参照上述步骤即可。

## 设置发票机器人

1. 下载压缩包后，将其解压至自己的用户目录下，比如"C:\Users\Peter\"。注意不要放到C盘根目录或程序目录，可能会有权限问题。也可以解压到D盘等非系统盘。
2. 然后打开"fapiao_bot"文件夹下的"config.json"文件，设置邮箱：

```json
{
    "email": {
        "server": "imap.163.com",
        "port": 993,
        "username": "你的邮箱",
        "password": "你的IMAP授权码",
        "use_ssl": true
    },
    "fapiao_storage_path": "",
    "log_storage_path": "",
    "log_level": "INFO",
    "schedule_interval": "daily",
    "proxy": {
        "enabled": false,
        "server": "proxy.example.com",
        "port": 8080,
        "username": "proxy_username",
        "password": "proxy_password"
    }
}
```

只设置"email"相关的内容即可，其他内容可以保持默认。如果使用其他邮箱，"server"和"port"需要对应修改。

3. 在Windows开始菜单中，搜索"任务计划程序"

    ![搜索"任务计划程序"](https://imgs.boringhex.top/blog/20231012214618.png)

4. 单击打开，然后单击右侧的"创建基本任务"，打开"创建基本任务向导"

    ![创建基本任务向导](https://imgs.boringhex.top/blog/20231012215026.png)

5. 设置为每天执行，时间可以根据自己情况设定，比如午休结束后或下班前。
6. "操作"这一步，选择"启动程序"，然后浏览选择"fapiao_bot"文件夹下"run.bat"这个文件

    ![浏览选择"run.bat"](https://imgs.boringhex.top/blog/20231012215524.png)

点击"下一步"，完成设置。

## 使用说明

完成上述设置后，发票机器人程序每天在设定的时间运行，一般不需要介入操作，但是不同商家的发票邮件五花八门，存在下载不成功的可能，没有下载成功的邮件会被重新标记为"未读"，所以建议还是定期登录邮箱检查一下。同时希望大家将没有下载成功的邮件转发到fapiao_bot@163.com，以便后续改进，谢谢。

下载的发票会保存到"fapiao_bot"同级目录下的"fapiao"文件夹中，并按年份/月份进行存放，比如2023年10月份的发票会保存在"fapiao/2023/10"这个文件夹中。

## 下载链接

## 问题反馈

如果遇到问题，欢迎加入下面的微信群进行讨论。

![FapiaoBot Issues](https://imgs.boringhex.top/blog/20231012221749.png)
